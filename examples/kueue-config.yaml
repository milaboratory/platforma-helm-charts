# Example: Kueue Configuration for Platforma
#
# This example shows how to configure Kueue with the platforma Helm chart.
# Copy and modify this configuration based on your needs.
#
# IMPORTANT: Replace the following placeholders:
#   - <RELEASE_NAME>: Your Helm release name (e.g., "my-platforma")
#   - <NAMESPACE>: Your target namespace (e.g., "platforma")

# Enable Kubernetes runner with Kueue
k8s:
  enabled: true
  kueue:
    # Enable creation of Kueue resources (ResourceFlavor, ClusterQueue, LocalQueue)
    enabled: true
    
    # ResourceFlavor - defines resource types available in the cluster
    resourceFlavor:
      name: "default"
    
    # ClusterQueue - defines resource quotas for the cluster
    clusterQueue:
      name: "platforma-cluster-queue"
      resources:
        cpu: "32"       # Total CPU quota
        memory: "64Gi"  # Total memory quota
    
    # LocalQueue - namespaced queue that jobs are submitted to
    localQueue:
      name: "platforma-local-queue"

# Kueue controller configuration (subchart alias: kueue-controller)
kueue-controller:
  # Disable visibility API to avoid additional RBAC requirements
  enableVisibilityAPF: false
  
  # Controller manager configuration
  # IMPORTANT: Update <RELEASE_NAME> and <NAMESPACE> to match your deployment
  managerConfig:
    controllerManagerConfigYaml: |
      apiVersion: config.kueue.x-k8s.io/v1beta1
      kind: Configuration
      namespace: <NAMESPACE>
      health:
        healthProbeBindAddress: :8081
      metrics:
        bindAddress: :8443
      webhook:
        port: 9443
      leaderElection:
        leaderElect: true
        resourceName: c1f6bfd2.kueue.x-k8s.io
      controller:
        groupKindConcurrency:
          Job.batch: 5
          Pod: 5
          Workload.kueue.x-k8s.io: 5
          LocalQueue.kueue.x-k8s.io: 1
          ClusterQueue.kueue.x-k8s.io: 1
          ResourceFlavor.kueue.x-k8s.io: 1
      clientConnection:
        qps: 50
        burst: 100
      # Certificate management - names must match release name pattern
      internalCertManagement:
        enable: true
        webhookServiceName: <RELEASE_NAME>-kueue-controller-webhook-service
        webhookSecretName: <RELEASE_NAME>-kueue-controller-webhook-server-cert
      # Frameworks that Kueue will manage
      integrations:
        frameworks:
        - "batch/job"
      # WaitForPodsReady: All-or-nothing scheduling
      # Ensures all pods become ready within timeout or workload is requeued
      waitForPodsReady:
        enable: true
        timeout: 10s              # Time for pods to become ready after admission
        recoveryTimeout: 3m       # Time for running workloads with failing pods
        blockAdmission: false     # If true, blocks new admissions until current are ready
        requeuingStrategy:
          timestamp: Eviction     # Requeue ordering: "Eviction" or "Creation"
          backoffLimitCount: 5    # Max requeue attempts (null = infinite)
          backoffBaseSeconds: 60  # Base delay between retries
          backoffMaxSeconds: 3600 # Maximum delay between retries
      # Garbage collection: Auto-delete completed/failed workloads
      objectRetentionPolicies:
        workloads:
          afterFinished: "1h"              # Delete finished workloads after 1 hour
          afterDeactivatedByKueue: "30m"   # Delete evicted workloads after 30 minutes
