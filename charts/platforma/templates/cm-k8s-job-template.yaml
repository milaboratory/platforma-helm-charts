{{- if .Values.k8s.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ printf "%s-k8s-job-template" (include "platforma.fullname" .) }}
  labels:
    {{- include "platforma.labels" . | nindent 4 }}
data:
  # Two-phase template:
  # - Phase 1 (Helm): {{ .Values.xxx }} variables are substituted during helm install/upgrade
  # - Phase 2 (Backend): << .Variable >> variables are substituted at job creation time
  job-template.yaml: |-
    # Kubernetes Job Template for Platforma
    #
    # Syntax: << .Variable >> - Backend parameters (processed by Platforma at job creation)
    #
    # Template variables and their sources:
    #   .Name                      - Generated from JobNamePrefix + ResourceID
    #   .Namespace                 - From Helm: k8s.namespace (or deployment namespace)
    #   .Image                     - Block's container image
    #   .ContainerName             - Generated container name
    #   .WorkDirName               - Resource-specific workdir name (e.g., "abc123")
    #   .Env                       - Environment variables for the container (includes PL_JOB_CMD_AND_ARGS)
    #   .SecurityContext           - Optional RunAsUser/RunAsGroup from Helm
    #   .PriorityClass             - Priority class for Kueue queue selection ("ui-tasks" or "batch-tasks")
    #
    # Helm-substituted values (baked in at deploy time):
    #   mountPath: {{ include "platforma.instanceMainRootMountPath" . }}
    #   workDirFolder: {{ .Values.persistence.mainRoot.workDirName }}
    #   pvcName: {{- if .Values.persistence.mainRoot.existingClaim }} {{ .Values.persistence.mainRoot.existingClaim }}{{- else }} {{ printf "%s-main-root" (include "platforma.fullname" .) }}{{- end }}
    apiVersion: batch/v1
    kind: Job
    metadata:
      name: << .Name >>
      namespace: << .Namespace >>
      {{- if .Values.k8s.kueue.enabled }}
      labels:
        <<- if eq .PriorityClass "ui-tasks" >>
        kueue.x-k8s.io/queue-name: "{{ .Values.k8s.kueue.queues.uiTasks }}"
        kueue.x-k8s.io/priority-class: "{{ .Values.k8s.kueue.queues.uiTasks }}"
        <<- else >>
        kueue.x-k8s.io/queue-name: "{{ .Values.k8s.kueue.queues.batchTasks }}"
        kueue.x-k8s.io/priority-class: "{{ .Values.k8s.kueue.queues.batchTasks }}"
        <<- end >>
      {{- end }}
    spec:
      # Kueue requires jobs to be created suspended so it can manage their admission.
      suspend: true
      # No retries - Platforma handles retry logic
      backoffLimit: 0
      template:
        spec:
          restartPolicy: Never
          containers:
            - name: << .ContainerName >>
              image: << .Image >>
              # Command runs job_script.sh which reads PL_JOB_CMD_AND_ARGS env var
              command: ["/bin/sh", "{{ include "platforma.mainRootWorkDir" . }}/job_script.sh"]
              # workingDir = mountPath/workDirFolder/WorkDirName
              workingDir: {{ include "platforma.mainRootWorkDir" . }}/<< .WorkDirName >>
              <<- if .Env >>
              env:
                <<- range .Env >>
                - name: << .Name >>
                  <<- if .SecretName >>
                  valueFrom:
                    secretKeyRef:
                      name: << .SecretName >>
                      key: << .SecretName >>
                  <<- else >>
                  value: << .Value | quote >>
                  <<- end >>
                <<- end >>
              <<- end >>
              volumeMounts:
                - name: workdirs
                  mountPath: {{ include "platforma.mainRootWorkDir" . }}/<< .WorkDirName >>
                - name: job-script
                  mountPath: {{ include "platforma.mainRootWorkDir" . }}/job_script.sh
                  subPath: job_script.sh
                  readOnly: true
              <<- if .SecurityContext >>
              securityContext:
                <<- if .SecurityContext.RunAsUser >>
                runAsUser: << .SecurityContext.RunAsUser >>
                <<- end >>
                <<- if .SecurityContext.RunAsGroup >>
                runAsGroup: << .SecurityContext.RunAsGroup >>
                <<- end >>
              <<- end >>
          volumes:
            - name: workdirs
              persistentVolumeClaim:
                claimName: {{- if .Values.persistence.mainRoot.existingClaim }} {{ .Values.persistence.mainRoot.existingClaim }}{{- else }} {{ printf "%s-main-root" (include "platforma.fullname" .) }}{{- end }}
            - name: common
              persistentVolumeClaim:
                claimName: {{- if .Values.persistence.mainRoot.existingClaim }} {{ .Values.persistence.mainRoot.existingClaim }}{{- else }} {{ printf "%s-main-root" (include "platforma.fullname" .) }}{{- end }}
            - name: job-script
              configMap:
                name: {{ printf "%s-k8s-job-script" (include "platforma.fullname" .) }}
                defaultMode: 0755
{{- end }}
