apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "platforma.fullname" . }}
  labels:
    {{- include "platforma.labels" . | nindent 4 }}
spec:
  {{- include "platforma.validatePrimaryStorage" . | nindent 2 }}
  {{- include "platforma.validatePersistence" . | nindent 2 }}

  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      {{- include "platforma.selectorLabels" . | nindent 6 }}
  strategy:
    type: {{ .Values.deployment.strategy.type }}
    {{- if eq .Values.deployment.strategy.type "RollingUpdate" }}
    rollingUpdate:
      {{- toYaml .Values.deployment.strategy.rollingUpdate | nindent 6 }}
    {{- end }}
  template:
    metadata:
      labels:
        {{- include "platforma.selectorLabels" . | nindent 8 }}
        {{- with .Values.deployment.podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      annotations:
        {{- if .Values.deployment.redeployOnUpgrade }}
        helm.sh/redeploy-on-upgrade: {{ now | unixEpoch | quote }}
        {{- end }}
        {{- with .Values.deployment.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:
      {{- if .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml .Values.imagePullSecrets | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "platforma.serviceAccountName" . }}
      {{- with .Values.deployment.podSecurityContext }}
      securityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if and .Values.persistence.mainRoot.initDirsChown .Values.deployment.securityContext.runAsUser }}
      initContainers:
        - name: chown-volumes
          image: "busybox:1.36"
          imagePullPolicy: IfNotPresent
          securityContext:
            runAsUser: 0
            runAsGroup: 0
            runAsNonRoot: false
          command:
            - /bin/sh
            - -c
            - |
              WORK_DIR="{{ include "platforma.mainRootWorkDir" . }}"
              PACKAGES_DIR="{{ include "platforma.instanceMainRootMountPath" . }}/{{ .Values.persistence.mainRoot.packagesDirName }}"
              COMMON_DIR="{{ include "platforma.instanceMainRootMountPath" . }}/common"
              USER_ID="{{ .Values.deployment.securityContext.runAsUser }}"
              GROUP_ID="{{ .Values.deployment.securityContext.runAsGroup | default .Values.deployment.securityContext.runAsUser }}"

              mkdir -p "$WORK_DIR" "$PACKAGES_DIR" "$COMMON_DIR"
              chown -R "$USER_ID:$GROUP_ID" "$WORK_DIR" "$PACKAGES_DIR" "$COMMON_DIR"
              echo "Changed ownership of $WORK_DIR, $PACKAGES_DIR and $COMMON_DIR to $USER_ID:$GROUP_ID"
          volumeMounts:
            {{- include "platforma.volumeMounts" . | nindent 12 }}
      {{- end }}
      containers:
        - name: {{ .Chart.Name }}
          {{- with .Values.deployment.securityContext }}
          securityContext:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          {{- if .Values.deployment.command.enabled }}
          command:
            {{- toYaml .Values.deployment.command.command | nindent 12 }}
          {{- end }}
          args:
            - "run"
            # Main Options
            {{- if .Values.mainOptions.licenseFile.enabled }}
            {{- if .Values.mainOptions.licenseFile.secretRef.enabled }}
            - "--license-file=/etc/platforma/secrets/license/{{ required "A key for the license file secret is required (.Values.mainOptions.licenseFile.secretRef.key)" .Values.mainOptions.licenseFile.secretRef.key }}"
            {{- else }}
            - "--license-file={{ .Values.mainOptions.licenseFile.path }}"
            {{- end }}
            {{- end }}
            # Local Storage
            # mainRoot is always created
            - "--main-root={{ include "platforma.instanceMainRootMountPath" . }}"
            # workDir and packagesDir are subfolders within mainRoot
            # dbDir can optionally be a separate PVC
            {{- if .Values.persistence.dbDir.enabled }}
            - "--db-dir={{ .Values.persistence.dbDir.mountPath }}"
            {{- end }}
            # Listen Options
            - "--listen-address={{ .Values.listenOptions.ip }}"
            - "--listen-port={{ .Values.listenOptions.port }}"
            {{- if .Values.primaryStorage.fs.enabled }}
            - "--listen-http-port={{ .Values.listenOptions.httpPort }}"
            {{- end }}
            {{- if .Values.listenOptions.tls.enabled }}
            - "--listen-tls={{ .Values.listenOptions.tls.certPath }},{{ .Values.listenOptions.tls.keyPath }}"
            {{- end }}
            {{- if .Values.listenOptions.selfSignedTls }}
            - "--self-signed-tls"
            {{- if .Values.listenOptions.selfSignedTlsOrg }}
            - "--self-signed-tls-org={{ .Values.listenOptions.selfSignedTlsOrg }}"
            {{- end }}
            {{- if .Values.listenOptions.selfSignedTlsDomains }}
            {{- range .Values.listenOptions.selfSignedTlsDomains }}
            - "--self-signed-tls-domain={{ . }}"
            {{- end }}
            {{- end }}
            {{- if .Values.listenOptions.selfSignedTlsIps }}
            {{- range .Values.listenOptions.selfSignedTlsIps }}
            - "--self-signed-tls-ip={{ . }}"
            {{- end }}
            {{- end }}
            {{- end }}
            # Primary Storage Options
            {{- if .Values.primaryStorage.s3.enabled }}
            - "--primary-storage-s3={{ .Values.primaryStorage.s3.url }}"
            {{- if .Values.primaryStorage.s3.region }}
            - "--primary-storage-s3-region={{ .Values.primaryStorage.s3.region }}"
            {{- end }}
            {{- if .Values.primaryStorage.s3.secretRef.enabled }}
            - "--primary-storage-s3-key=/etc/platforma/secrets/primary-storage-s3/{{ required "A keyKey for the primary storage S3 secret is required (.Values.primaryStorage.s3.secretRef.keyKey)" .Values.primaryStorage.s3.secretRef.keyKey }}"
            - "--primary-storage-s3-secret=/etc/platforma/secrets/primary-storage-s3/{{ required "A secretKey for the primary storage S3 secret is required (.Values.primaryStorage.s3.secretRef.secretKey)" .Values.primaryStorage.s3.secretRef.secretKey }}"
            {{- else }}
            {{- if .Values.primaryStorage.s3.key }}
            - "--primary-storage-s3-key={{ .Values.primaryStorage.s3.key }}"
            {{- end }}
            {{- if .Values.primaryStorage.s3.secret }}
            - "--primary-storage-s3-secret={{ .Values.primaryStorage.s3.secret }}"
            {{- end }}
            {{- end }}
            {{- if .Values.primaryStorage.s3.externalEndpoint }}
            - "--primary-storage-s3-external-endpoint={{ .Values.primaryStorage.s3.externalEndpoint }}"
            {{- end }}
            {{- if .Values.primaryStorage.s3.noDataIntegrity }}
            - "--primary-storage-s3-no-data-integrity"
            {{- end }}
            {{- end }}
            {{- if .Values.primaryStorage.fs.enabled }}
            {{- if .Values.primaryStorage.fs.autoUrl }}
            - "--primary-storage-fs-url=https://localhost:{{ .Values.listenOptions.httpPort }}"
            {{- else if .Values.primaryStorage.fs.url }}
            - "--primary-storage-fs-url={{ .Values.primaryStorage.fs.url }}"
            {{- end }}
            {{- if .Values.primaryStorage.fs.persistence.enabled }}
            - "--primary-storage-fs={{ .Values.primaryStorage.fs.persistence.mountPath }}"
            {{- end }}
            {{- end }}
            {{- if .Values.primaryStorage.gcs.enabled }}
            - "--primary-storage-gcs={{ .Values.primaryStorage.gcs.url }}"
            {{- $gcpProject := .Values.gcp.projectId | default .Values.primaryStorage.gcs.projectId }}
            {{- if $gcpProject }}
            - "--primary-storage-gcs-project-id={{ $gcpProject }}"
            {{- end }}
            {{- $gcpSa := include "platforma.gcpServiceAccount" . }}
            {{- if $gcpSa }}
            - "--primary-storage-gcs-service-account={{ $gcpSa }}"
            {{- end }}
            {{- end }}
            # Data Library Options
            {{- if .Values.dataLibrary.noHostDataLibrary }}
            - "--no-host-data-library"
            {{- end }}
            {{- range .Values.dataLibrary.fs }}
            {{- if .persistence.enabled }}
            - "--data-library-fs={{ .id }}={{ .path }}"
            {{- end }}
            {{- end }}
            {{- range .Values.dataLibrary.s3 }}
            {{- if .enabled }}
            - "--data-library-s3={{ .id }}={{ .url }}"
            {{- if .region }}
            - "--data-library-s3-region={{ .id }}={{ .region }}"
            {{- end }}
            {{- if .secretRef.enabled }}
            - "--data-library-s3-key={{ .id }}=/etc/platforma/secrets/datalib-s3/{{ .id }}/{{ required (printf "A keyKey for the data library S3 secret is required (dataLibrary.s3[%s].secretRef.keyKey)" .id) .secretRef.keyKey }}"
            - "--data-library-s3-secret={{ .id }}=/etc/platforma/secrets/datalib-s3/{{ .id }}/{{ required (printf "A secretKey for the data library S3 secret is required (dataLibrary.s3[%s].secretRef.secretKey)" .id) .secretRef.secretKey }}"
            {{- else }}
            {{- if .key }}
            - "--data-library-s3-key={{ .id }}={{ .key }}"
            {{- end }}
            {{- if .secret }}
            - "--data-library-s3-secret={{ .id }}={{ .secret }}"
            {{- end }}
            {{- end }}
            {{- if .externalEndpoint }}
            - "--data-library-s3-external-endpoint={{ .id }}={{ .externalEndpoint }}"
            {{- end }}
            {{- if .noDataIntegrity }}
            - "--data-library-s3-no-data-integrity={{ .id }}=true"
            {{- end }}
            {{- end }}
            {{- end }}
            {{- range .Values.dataLibrary.gcs }}
            {{- if .enabled }}
            - "--data-library-gcs={{ .id }}={{ .url }}"
            {{- $dlProject := $.Values.gcp.projectId | default .projectId }}
            {{- if $dlProject }}
            - "--data-library-gcs-project-id={{ .id }}={{ $dlProject }}"
            {{- end }}
            {{- $dlSa := .serviceAccount | default $.Values.gcp.serviceAccount }}
            {{- if $dlSa }}
            - "--data-library-gcs-service-account={{ .id }}={{ $dlSa }}"
            {{- end }}
            {{- if .jsonKeyFilePath }}
            - "--data-library-gcs-json-key-file-path={{ .id }}={{ .jsonKeyFilePath }}"
            {{- end }}
            {{- end }}
            {{- end }}
            # Google Batch Options
            {{- if .Values.googleBatch.enabled }}
            - "--google-batch-storage={{ .Values.googleBatch.storage }}"
            {{- $gbProject := .Values.gcp.projectId | default .Values.googleBatch.project }}
            {{- if $gbProject }}
            - "--google-batch-project={{ $gbProject }}"
            {{- end }}
            {{- if .Values.googleBatch.region }}
            - "--google-batch-region={{ .Values.googleBatch.region }}"
            {{- end }}
            {{- if .Values.googleBatch.jobNamePrefix }}
            - "--google-batch-job-name-prefix={{ .Values.googleBatch.jobNamePrefix }}"
            {{- end }}
            {{- if .Values.googleBatch.jobImage }}
            - "--google-batch-job-image={{ .Values.googleBatch.jobImage }}"
            {{- end }}
            - "--google-batch-network={{ .Values.googleBatch.network }}"
            - "--google-batch-subnetwork={{ .Values.googleBatch.subnetwork }}"
            - "--google-batch-provisioning={{ .Values.googleBatch.provisioning }}"
            {{- $gbSa := .Values.googleBatch.serviceAccount | default .Values.gcp.serviceAccount }}
            {{- if $gbSa }}
            - "--google-batch-service-account={{ $gbSa }}"
            {{- end }}
            {{- if .Values.googleBatch.customJobTemplate.enabled }}
            {{- if .Values.googleBatch.customJobTemplate.configMap.name }}
            - "--google-batch-custom-job-template=/etc/platforma/templates/google-batch-custom-job-template-cm/{{ .Values.googleBatch.customJobTemplate.configMap.key }}"
            {{- else if .Values.googleBatch.customJobTemplate.inline }}
            - "--google-batch-custom-job-template=/etc/platforma/templates/google-batch-custom-job-template-inline/job-template.tmpl"
            {{- end }}
            {{- end }}
            {{- end }}
            # Authentication Options
            {{- if and (not .Values.authOptions.htpasswd.enabled) (not .Values.authOptions.ldap.enabled) }}
            - "--no-auth"
            {{- else }}
            {{- if .Values.authOptions.htpasswd.enabled }}
            {{- if .Values.authOptions.htpasswd.secretRef.enabled }}
            - "--auth-htpasswd=/etc/platforma/secrets/htpasswd/{{ required "A key for the htpasswd secret is required (.Values.authOptions.htpasswd.secretRef.key)" .Values.authOptions.htpasswd.secretRef.key }}"
            {{- else }}
            - "--auth-htpasswd={{ .Values.authOptions.htpasswd.path }}"
            {{- end }}
            {{- end }}
            {{- if .Values.authOptions.ldap.enabled }}
            - "--auth-ldap-server={{ .Values.authOptions.ldap.server }}"
            {{- if .Values.authOptions.ldap.dn }}
            - "--auth-ldap-dn={{ .Values.authOptions.ldap.dn }}"
            {{- end }}
            {{- if .Values.authOptions.ldap.startTls }}
            - "--auth-ldap-start-tls"
            {{- end }}
            {{- if .Values.authOptions.ldap.tls.enabled }}
            {{- if .Values.authOptions.ldap.tls.client.secretRef.enabled }}
            - "--auth-ldap-tls=/etc/platforma/secrets/ldap-client/{{ required "A certKey for the LDAP client certificate secret is required (.Values.authOptions.ldap.tls.client.secretRef.certKey)" .Values.authOptions.ldap.tls.client.secretRef.certKey }},/etc/platforma/secrets/ldap-client/{{ required "A keyKey for the LDAP client certificate secret is required (.Values.authOptions.ldap.tls.client.secretRef.keyKey)" .Values.authOptions.ldap.tls.client.secretRef.keyKey }}"
            {{- else if .Values.authOptions.ldap.tls.client.configMapRef.enabled }}
            - "--auth-ldap-tls=/etc/platforma/cm/ldap-client/{{ .Values.authOptions.ldap.tls.client.configMapRef.certKey }},/etc/platforma/cm/ldap-client/{{ .Values.authOptions.ldap.tls.client.configMapRef.keyKey }}"
            {{- else if and .Values.authOptions.ldap.tls.client.certPath .Values.authOptions.ldap.tls.client.keyPath }}
            - "--auth-ldap-tls={{ .Values.authOptions.ldap.tls.client.certPath }},{{ .Values.authOptions.ldap.tls.client.keyPath }}"
            {{- end }}
            {{- if .Values.authOptions.ldap.tls.ca.secretRef.enabled }}
            - "--auth-ldap-cas=/etc/platforma/secrets/ldap-ca/{{ required "A key for the LDAP CA certificate secret is required (.Values.authOptions.ldap.tls.ca.secretRef.key)" .Values.authOptions.ldap.tls.ca.secretRef.key }}"
            {{- else if .Values.authOptions.ldap.tls.ca.configMapRef.enabled }}
            - "--auth-ldap-cas=/etc/platforma/cm/ldap-ca/{{ .Values.authOptions.ldap.tls.ca.configMapRef.key }}"
            {{- else if .Values.authOptions.ldap.tls.ca.path }}
            - "--auth-ldap-cas={{ .Values.authOptions.ldap.tls.ca.path }}"
            {{- end }}
            {{- end }}
            {{- if .Values.authOptions.ldap.rootCas.secretRef.enabled }}
            - "--auth-ldap-root-cas=/etc/platforma/secrets/ldap-root-cas/{{ required "A key for the LDAP root CA certificates secret is required (.Values.authOptions.ldap.rootCas.secretRef.key)" .Values.authOptions.ldap.rootCas.secretRef.key }}"
            {{- else if .Values.authOptions.ldap.rootCas.configMapRef.enabled }}
            - "--auth-ldap-root-cas=/etc/platforma/cm/ldap-root-cas/{{ .Values.authOptions.ldap.rootCas.configMapRef.key }}"
            {{- else if .Values.authOptions.ldap.rootCas.path }}
            - "--auth-ldap-root-cas={{ .Values.authOptions.ldap.rootCas.path }}"
            {{- end }}
            {{- end }}
            {{- end }}
            # Logging Options
            - "--log-dst={{ .Values.logging.destination }}"
            {{- if hasPrefix "dir://" .Values.logging.destination }}
            - "--log-rotation-size={{ .Values.logging.rotation.size }}"
            - "--log-rotation-backups={{ .Values.logging.rotation.count }}"
            {{- end -}}
            # Monitoring Options
            {{- if .Values.monitoring.enabled }}
            - "--monitoring-ip={{ .Values.listenOptions.ip }}"
            - "--monitoring-port={{ .Values.monitoring.port }}"
            {{- else }}
            - "--no-monitoring"
            {{- end }}
            # Debug Options
            {{- if .Values.debug.enabled }}
            - "--debug-enabled"
            - "--debug-ip={{ .Values.listenOptions.ip }}"
            - "--debug-port={{ .Values.debug.port }}"
            {{- end }}
            # Docker Options
            {{- if .Values.docker.enabled }}
            {{- $dockerResources := fromYaml (include "platforma.dockerResources" .) }}
            - "--runner-enable-docker"
            {{- if $dockerResources.limits.cpu }}
            - "--runner-local-cpu={{ include "platforma.parseCpuToWholeCpus" $dockerResources.limits.cpu }}"
            {{- end }}
            {{- if $dockerResources.limits.memory }}
            - "--runner-local-ram={{ $dockerResources.limits.memory }}"
            {{- end }}
            {{- end }}
            {{- if .Values.gcp.gar }}
            - "--google-artifact-registry={{ .Values.gcp.gar }}"
            - "--default-docker-registry={{ .Values.gcp.gar }}"
            {{- end -}}
            {{- if .Values.assetsRegistry }}
            - "--assets-registry-url={{ .Values.assetsRegistry }}"
            {{- end -}}
            {{- if .Values.k8s.enabled }}
            # K8s job template is provided via ConfigMap with Helm values baked in.
            # Backend only needs to pass dynamic values like WorkDirName.
            - "--k8s-namespace={{ .Release.Namespace }}"
            - "--k8s-custom-job-template=/etc/platforma/templates/k8s-job-template/job-template.yaml"
            {{- end -}}
            {{- if hasPrefix "dir://" .Values.logging.destination }}
            - "--monitoring-dump-dir={{ trimPrefix "dir://" .Values.logging.destination }}"
            {{- end }}

            # Extra Arguments
            {{- range .Values.extraArgs }}
            - {{ . | quote }}
            {{- end }}
          ports:
            - name: grpc
              containerPort: {{ .Values.listenOptions.port }}
              protocol: TCP
            {{- if .Values.primaryStorage.fs.enabled }}
            - name: http
              containerPort: {{ .Values.listenOptions.httpPort }}
              protocol: TCP
            {{- end }}
            {{- if .Values.monitoring.enabled }}
            - name: monitoring
              containerPort: {{ .Values.monitoring.port }}
              protocol: TCP
            {{- end }}
            {{- if .Values.debug.enabled }}
            - name: debug
              containerPort: {{ .Values.debug.port }}
              protocol: TCP
            {{- end }}
          env:
            {{- range $key, $value := .Values.env.variables }}
            - name: {{ $key }}
              value: {{ $value | quote }}
            {{- end }}
            {{- if .Values.docker.enabled }}
            - name: DOCKER_HOST
              value: {{ include "platforma.dockerHost" . }}
            {{- end }}
            {{- range .Values.env.secretVariables }}
            - name: {{ .name }}
              valueFrom:
                secretKeyRef:
                  name: {{ .secretKeyRef.name }}
                  key: {{ .secretKeyRef.key }}
                  {{- if hasKey .secretKeyRef "optional" }}
                  optional: {{ .secretKeyRef.optional }}
                  {{- end }}
            {{- end }}
            {{- if and .Values.authOptions.ldap.enabled .Values.authOptions.ldap.searchPassword.envRef.enabled }}
            - name: PL_AUTH_LDAP_SEARCH_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ required "A name for the LDAP search password secret is required (.Values.authOptions.ldap.searchPassword.envRef.name)" .Values.authOptions.ldap.searchPassword.envRef.name }}
                  key: {{ required "A key for the LDAP search password secret is required (.Values.authOptions.ldap.searchPassword.envRef.key)" .Values.authOptions.ldap.searchPassword.envRef.key }}
            {{- end }}
            {{- range .Values.env.configMapVariables }}
            - name: {{ .name }}
              valueFrom:
                configMapKeyRef:
                  name: {{ .configMapKeyRef.name }}
                  key: {{ .configMapKeyRef.key }}
                  {{- if hasKey .configMapKeyRef "optional" }}
                  optional: {{ .configMapKeyRef.optional }}
                  {{- end }}
            {{- end }}
          {{- with .Values.probes.liveness }}
          {{- if .enabled }}
          livenessProbe:
            {{- if eq .type "httpGet" }}
            httpGet:
              path: {{ .httpGet.path }}
              port: {{ .httpGet.port }}
            {{- else if eq .type "tcpSocket" }}
            tcpSocket:
              port: {{ .tcpSocket.port }}
            {{- else if eq .type "grpc" }}
            grpc:
              port: {{ .grpc.port }}
              {{- if .grpc.service }}
              service: {{ .grpc.service }}
              {{- end }}
            {{- end }}
            initialDelaySeconds: {{ .initialDelaySeconds }}
            periodSeconds: {{ .periodSeconds }}
            timeoutSeconds: {{ .timeoutSeconds }}
            successThreshold: {{ .successThreshold }}
            failureThreshold: {{ .failureThreshold }}
          {{- end }}
          {{- end }}
          {{- with .Values.probes.readiness }}
          {{- if .enabled }}
          readinessProbe:
            {{- if eq .type "httpGet" }}
            httpGet:
              path: {{ .httpGet.path }}
              port: {{ .httpGet.port }}
            {{- else if eq .type "tcpSocket" }}
            tcpSocket:
              port: {{ .tcpSocket.port }}
            {{- else if eq .type "grpc" }}
            grpc:
              port: {{ .grpc.port }}
              {{- if .grpc.service }}
              service: {{ .grpc.service }}
              {{- end }}
            {{- end }}
            initialDelaySeconds: {{ .initialDelaySeconds }}
            periodSeconds: {{ .periodSeconds }}
            timeoutSeconds: {{ .timeoutSeconds }}
            successThreshold: {{ .successThreshold }}
            failureThreshold: {{ .failureThreshold }}
          {{- end }}
          {{- end }}
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
          # -- A list of volume mounts for the application container.
          # This is automatically populated based on your persistence settings.
          volumeMounts:
            {{- if and .Values.googleBatch.enabled .Values.googleBatch.customJobTemplate.enabled .Values.googleBatch.customJobTemplate.configMap.name }}
            - name: google-batch-custom-job-template-cm
              mountPath: "/etc/platforma/templates/google-batch-custom-job-template-cm"
              readOnly: true
            {{- else if and .Values.googleBatch.enabled .Values.googleBatch.customJobTemplate.enabled .Values.googleBatch.customJobTemplate.inline }}
            - name: google-batch-custom-job-template-inline
              mountPath: "/etc/platforma/templates/google-batch-custom-job-template-inline"
              readOnly: true
            {{- end }}
            {{- if .Values.k8s.enabled }}
            - name: k8s-job-template
              mountPath: "/etc/platforma/templates/k8s-job-template"
              readOnly: true
            {{- end }}
            {{- include "platforma.volumeMounts" . | nindent 12 }}
            {{- if .Values.mainOptions.licenseFile.secretRef.enabled }}
            - name: license-secret
              mountPath: "/etc/platforma/secrets/license"
              readOnly: true
            {{- end }}
            {{- if .Values.primaryStorage.s3.secretRef.enabled }}
            - name: primary-storage-s3-secret
              mountPath: "/etc/platforma/secrets/primary-storage-s3"
              readOnly: true
            {{- end }}
            {{- range .Values.dataLibrary.s3 }}
            {{- if and .enabled .secretRef.enabled }}
            - name: datalib-s3-{{ .id }}
              mountPath: "/etc/platforma/secrets/datalib-s3/{{ .id }}"
              readOnly: true
            {{- end }}
            {{- end }}
            {{- if .Values.authOptions.htpasswd.secretRef.enabled }}
            - name: htpasswd-secret
              mountPath: "/etc/platforma/secrets/htpasswd"
              readOnly: true
            {{- end }}
            {{- if and .Values.authOptions.ldap.enabled .Values.authOptions.ldap.tls.enabled }}
            {{- if .Values.authOptions.ldap.tls.client.secretRef.enabled }}
            - name: ldap-client-secret
              mountPath: "/etc/platforma/secrets/ldap-client"
              readOnly: true
            {{- end }}
            {{- if .Values.authOptions.ldap.tls.client.configMapRef.enabled }}
            - name: ldap-client-cm
              mountPath: "/etc/platforma/cm/ldap-client"
              readOnly: true
            {{- end }}
            {{- if .Values.authOptions.ldap.tls.ca.secretRef.enabled }}
            - name: ldap-ca-secret
              mountPath: "/etc/platforma/secrets/ldap-ca"
              readOnly: true
            {{- end }}
            {{- if .Values.authOptions.ldap.tls.ca.configMapRef.enabled }}
            - name: ldap-ca-cm
              mountPath: "/etc/platforma/cm/ldap-ca"
              readOnly: true
            {{- end }}
            {{- end }}
            {{- if .Values.authOptions.ldap.enabled }}
            {{- if .Values.authOptions.ldap.rootCas.secretRef.enabled }}
            - name: ldap-root-cas-secret
              mountPath: "/etc/platforma/secrets/ldap-root-cas"
              readOnly: true
            {{- end }}
            {{- if .Values.authOptions.ldap.rootCas.configMapRef.enabled }}
            - name: ldap-root-cas-cm
              mountPath: "/etc/platforma/cm/ldap-root-cas"
              readOnly: true
            {{- end }}
            {{- end }}
      # -- Volumes for the pod.
      # This is automatically populated based on your persistence settings.
      volumes:
        {{- if and .Values.googleBatch.enabled .Values.googleBatch.customJobTemplate.enabled .Values.googleBatch.customJobTemplate.configMap.name }}
        - name: google-batch-custom-job-template-cm
          configMap:
            name: {{ .Values.googleBatch.customJobTemplate.configMap.name }}
        {{- else if and .Values.googleBatch.enabled .Values.googleBatch.customJobTemplate.enabled .Values.googleBatch.customJobTemplate.inline }}
        - name: google-batch-custom-job-template-inline
          configMap:
            name: {{ printf "%s-job-template" (include "platforma.fullname" .) }}
        {{- end }}
        {{- if .Values.k8s.enabled }}
        - name: k8s-job-template
          configMap:
            name: {{ printf "%s-k8s-job-template" (include "platforma.fullname" .) }}
        {{- end }}
        {{- include "platforma.volumes" . | nindent 8 }}
        {{- if .Values.mainOptions.licenseFile.secretRef.enabled }}
        - name: license-secret
          secret:
            secretName: {{ required "A name for the license file secret is required (.Values.mainOptions.licenseFile.secretRef.name)" .Values.mainOptions.licenseFile.secretRef.name }}
        {{- end -}}
        {{- if .Values.primaryStorage.s3.secretRef.enabled }}
        - name: primary-storage-s3-secret
          secret:
            secretName: {{ required "A name for the primary storage S3 secret is required (.Values.primaryStorage.s3.secretRef.name)" .Values.primaryStorage.s3.secretRef.name }}
        {{- end -}}
        {{- range .Values.dataLibrary.s3 }}
        {{- if and .enabled .secretRef.enabled }}
        - name: datalib-s3-{{ .id }}
          secret:
            secretName: {{ required (printf "A name for the data library S3 secret is required (dataLibrary.s3[%s].secretRef.name)" .id) .secretRef.name }}
        {{- end -}}
        {{- end -}}
        {{- if .Values.authOptions.htpasswd.secretRef.enabled }}
        - name: htpasswd-secret
          secret:
            secretName: {{ required "A name for the htpasswd secret is required (.Values.authOptions.htpasswd.secretRef.name)" .Values.authOptions.htpasswd.secretRef.name }}
        {{- end }}
        {{- if and .Values.authOptions.ldap.enabled .Values.authOptions.ldap.tls.enabled }}
        {{- if .Values.authOptions.ldap.tls.client.secretRef.enabled }}
        - name: ldap-client-secret
          secret:
            secretName: {{ required "A name for the LDAP client certificate secret is required (.Values.authOptions.ldap.tls.client.secretRef.name)" .Values.authOptions.ldap.tls.client.secretRef.name }}
        {{- end }}
        {{- if .Values.authOptions.ldap.tls.client.configMapRef.enabled }}
        - name: ldap-client-cm
          configMap:
            name: {{ .Values.authOptions.ldap.tls.client.configMapRef.name }}
        {{- end }}
        {{- if .Values.authOptions.ldap.tls.ca.secretRef.enabled }}
        - name: ldap-ca-secret
          secret:
            secretName: {{ required "A name for the LDAP CA certificate secret is required (.Values.authOptions.ldap.tls.ca.secretRef.name)" .Values.authOptions.ldap.tls.ca.secretRef.name }}
        {{- end }}
        {{- if .Values.authOptions.ldap.tls.ca.configMapRef.enabled }}
        - name: ldap-ca-cm
          configMap:
            name: {{ .Values.authOptions.ldap.tls.ca.configMapRef.name }}
        {{- end }}
        {{- end }}
        {{- if .Values.authOptions.ldap.enabled }}
        {{- if .Values.authOptions.ldap.rootCas.secretRef.enabled }}
        - name: ldap-root-cas-secret
          secret:
            secretName: {{ required "A name for the LDAP root CA certificates secret is required (.Values.authOptions.ldap.rootCas.secretRef.name)" .Values.authOptions.ldap.rootCas.secretRef.name }}
        {{- end }}
        {{- if .Values.authOptions.ldap.rootCas.configMapRef.enabled }}
        - name: ldap-root-cas-cm
          configMap:
            name: {{ .Values.authOptions.ldap.rootCas.configMapRef.name }}
        {{- end }}
        {{- end -}}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- if .podAffinity }}
        podAffinity:
          {{- toYaml .podAffinity | nindent 10 }}
        {{- end }}
        {{- if .podAntiAffinity }}
        podAntiAffinity:
          {{- toYaml .podAntiAffinity | nindent 10 }}
        {{- end }}
        {{- if .nodeAffinity }}
        nodeAffinity:
          {{- toYaml .nodeAffinity | nindent 10 }}
        {{- end }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
