{{- if and .Values.controller.enabled .Values.caPatcher.enabled }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "kueue-setup.fullname" . }}-ca-patcher
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "kueue-setup.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "kueue-setup.fullname" . }}-ca-patcher
  labels:
    {{- include "kueue-setup.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get"]
  - apiGroups: ["admissionregistration.k8s.io"]
    resources: ["mutatingwebhookconfigurations", "validatingwebhookconfigurations"]
    verbs: ["get", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ include "kueue-setup.fullname" . }}-ca-patcher
  labels:
    {{- include "kueue-setup.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
subjects:
  - kind: ServiceAccount
    name: {{ include "kueue-setup.fullname" . }}-ca-patcher
    namespace: {{ .Release.Namespace }}
roleRef:
  kind: ClusterRole
  name: {{ include "kueue-setup.fullname" . }}-ca-patcher
  apiGroup: rbac.authorization.k8s.io
---
# Using a Pod instead of Job to avoid Kueue webhook interception
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "kueue-setup.fullname" . }}-ca-patcher
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "kueue-setup.labels" . | nindent 4 }}
    app.kubernetes.io/component: ca-patcher
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "0"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  serviceAccountName: {{ include "kueue-setup.fullname" . }}-ca-patcher
  restartPolicy: OnFailure
  containers:
    - name: ca-patcher
      image: "{{ .Values.caPatcher.image.repository }}:{{ .Values.caPatcher.image.tag }}"
      imagePullPolicy: {{ .Values.caPatcher.image.pullPolicy }}
      command:
        - /bin/bash
        - -c
        - |
          set -e
          
          SECRET_NAME="{{ include "kueue-setup.webhookSecretName" . }}"
          NAMESPACE="{{ .Release.Namespace }}"
          MUTATING_WEBHOOK="{{ include "kueue-setup.mutatingWebhookName" . }}"
          VALIDATING_WEBHOOK="{{ include "kueue-setup.validatingWebhookName" . }}"
          TIMEOUT={{ .Values.caPatcher.timeout | default 300 }}
          
          echo "Waiting for Kueue controller to generate certificates..."
          ELAPSED=0
          while [ $ELAPSED -lt $TIMEOUT ]; do
            if kubectl get secret "$SECRET_NAME" -n "$NAMESPACE" -o jsonpath='{.data.ca\.crt}' 2>/dev/null | grep -q .; then
              echo "Certificate secret found!"
              break
            fi
            echo "Waiting for secret... ($ELAPSED/$TIMEOUT seconds)"
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done
          
          if [ $ELAPSED -ge $TIMEOUT ]; then
            echo "ERROR: Timeout waiting for certificate secret"
            exit 1
          fi
          
          # Get CA bundle from secret
          CA_BUNDLE=$(kubectl get secret "$SECRET_NAME" -n "$NAMESPACE" -o jsonpath='{.data.ca\.crt}')
          
          if [ -z "$CA_BUNDLE" ]; then
            echo "ERROR: CA bundle is empty"
            exit 1
          fi
          
          echo "CA bundle retrieved successfully"
          
          # Patch mutating webhook
          echo "Patching mutating webhook configuration..."
          WEBHOOK_COUNT=$(kubectl get mutatingwebhookconfiguration "$MUTATING_WEBHOOK" -o jsonpath='{.webhooks}' | jq 'length')
          for i in $(seq 0 $((WEBHOOK_COUNT - 1))); do
            kubectl patch mutatingwebhookconfiguration "$MUTATING_WEBHOOK" \
              --type='json' \
              -p="[{\"op\": \"replace\", \"path\": \"/webhooks/$i/clientConfig/caBundle\", \"value\": \"$CA_BUNDLE\"}]" || true
          done
          
          # Patch validating webhook
          echo "Patching validating webhook configuration..."
          WEBHOOK_COUNT=$(kubectl get validatingwebhookconfiguration "$VALIDATING_WEBHOOK" -o jsonpath='{.webhooks}' | jq 'length')
          for i in $(seq 0 $((WEBHOOK_COUNT - 1))); do
            kubectl patch validatingwebhookconfiguration "$VALIDATING_WEBHOOK" \
              --type='json' \
              -p="[{\"op\": \"replace\", \"path\": \"/webhooks/$i/clientConfig/caBundle\", \"value\": \"$CA_BUNDLE\"}]" || true
          done
          
          echo "Webhook CA bundles patched successfully!"
{{- end }}
